version: '{build}'
image: Visual Studio 2019
environment:
  matrix:
    # job names are used for FTP uploads, try to not change them
    - JOB_NAME: "win32"
      CMAKE_TARGET: "Visual Studio 16 2019"
      PLATFORM: "Win32"
      CMAKE_ARCH: "-A Win32"
    - JOB_NAME: "win64"
      CMAKE_TARGET: "Visual Studio 16 2019"
      PLATFORM: "x64"
      CMAKE_ARCH: "-A x64 -DPython_ROOT_DIR=C:\\Python311-x64"
    - JOB_NAME: "clang"
      CMAKE_TARGET: "Visual Studio 16 2019"
      PLATFORM: "Win32"
      CMAKE_ARCH: "-A Win32"
      CMAKE_PLATFORM_TOOLSET: "-T ClangCL"

install:
- cmd: >-
    mkdir build

    cd build

    set PATH=C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64\bin;%PATH%

    vcpkg integrate remove
    
    cmake %CMAKE_EXTRA_FLAGS% -G "%CMAKE_TARGET%" %CMAKE_PLATFORM_TOOLSET% %CMAKE_ARCH% ..\src

on_failure:
- cmd: >-

    type C:\projects\asar\build\CMakeFiles\CMakeOutput.log

    type C:\projects\asar\build\CMakeFiles\CMakeError.log

build:
  verbosity: minimal

artifacts:
- path: build\asar\bin\**\asar.exe
- path: build\asar\lib\**\*asar.dll

configuration: MinSizeRel

test_script:
  - cmd: >-
      cmake --build . --config MinSizeRel --target run-tests

deploy:
  provider: FTP
  protocol: sftp
  host: r9.pm
  username: asar_ftp
  password:
    secure: 2O8zpJfSlxa28ibgfgXNsca2OJhU4TAbOfpLaFcjf1BLqkLsjYHNlQ8p6PkI3Rki
  folder: asar/windows/$(APPVEYOR_REPO_BRANCH)/$(JOB_NAME)/
